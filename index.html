<!DOCTYPE html>
<html>
<head>
<title>TINIEST Electricity Model</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
<style>
.chart-container,
#inputs {
  max-width: 550px;
}
.input-header{
  color: #0088cc;
}
.input-header:hover{
  cursor: pointer;
}
#inputs-title{
  text-decoration: underline;
}
#page-title{
  text-align: center;
  margin-bottom: 20px;
}
h5{
  font-size: 1rem;
}
#output-data-title,
#run-analysis-title{
  margin-top: 30px;
  text-decoration: underline;
}
#run-analysis-loading{
  display: none;
  margin-top: 10px;
}
#download-data{
  color: #0088cc;
  cursor: pointer;
}
#CO2_price-slider-val{
  margin-right: 10px;
  display:inline-block;
  width: 20px;
}
#CO2_price-start_level{
  width: 300px;
}
#github-link{
  margin-top: 20px;
}

</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src='https://cdn.plot.ly/plotly-2.3.0.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js'></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9X6TEV9TB2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-9X6TEV9TB2');
</script>
</head>
<body>

<h4 id="page-title">The TINIEST (This Is Not - If Even Slightly - Thorough) Electricity Model</h4>
<div class="container">
  <div class="row">
    <div class="col">
      <form id="inputs">
        <h5 id="inputs-title">Inputs</h5>
        <!-- Load -->
        <h5 class="input-header" data-bs-toggle="collapse" data-bs-target="#load-div" aria-expanded="false" aria-controls="load-div">
          Load (TWh/yr)
        </h5>
        <div id="load-div" class="collapse">
          <table id="load-table" class="table table-sm table-striped">
            <tr id="load-header"></tr>
          </table>
        </div>
        <!-- Existing Gen -->
        <h5 class="input-header" data-bs-toggle="collapse" data-bs-target="#existing_gen-div" aria-expanded="false" aria-controls="existing_gen-div">
          Existing Tech Generation (TWh/yr, including planned retirements)
        </h5>
        <div id="existing_gen-div" class="collapse">
          <table id="existing_gen-table" class="table table-sm table-striped">
            <tr id="existing_gen-header"><th>Tech</th></tr>
          </table>
        </div>
        <!-- New tech LCOE -->
        <h5 class="input-header" data-bs-toggle="collapse" data-bs-target="#LCOE_new-div" aria-expanded="false" aria-controls="LCOE_new-div">
          New Technology LCOE at 0% market share (2018$/MWh)
        </h5>
        <div id="LCOE_new-div" class="collapse">
          <table id="LCOE_new-table" class="table table-sm table-striped">
            <tr id="LCOE_new-header"><th>Tech</th></tr>
          </table>
        </div>
        <!-- Existing tech LCOE -->
        <h5 class="input-header" data-bs-toggle="collapse" data-bs-target="#LCOE_exist-div" aria-expanded="false" aria-controls="LCOE_exist-div">
          Existing Technology LCOE at 0% market share (2018$/MWh)
        </h5>
        <div id="LCOE_exist-div" class="collapse">
          <table id="LCOE_exist-table" class="table table-sm table-striped">
            <tr id="LCOE_exist-header"><th>Tech</th></tr>
          </table>
        </div>
        <!-- LCOE slope-->
        <h5 class="input-header" data-bs-toggle="collapse" data-bs-target="#LCOE_slope-div" aria-expanded="false" aria-controls="LCOE_slope-div">
          LCOE Resource Supply Curve Slope (2018$/MWh per 1000 TWh)
        </h5>
        <div id="LCOE_slope-div" class="collapse">
          <table id="LCOE_slope-table" class="table table-sm table-striped">
            <tr id="LCOE_slope-header"><th>Tech</th><th>Slope</th></tr>
          </table>
        </div>
        <!-- Natural gas heat rate-->
        <h5 class="input-header" data-bs-toggle="collapse" data-bs-target="#NG_heatrate-div" aria-expanded="false" aria-controls="NG_heatrate-div">
          Natural gas heat rate (MMBtu/MWh)
        </h5>
        <div id="NG_heatrate-div" class="collapse">
          <table id="NG_heatrate-table" class="table table-sm table-striped">
            <tr id="NG_heatrate-header"><th>Tech</th><th>MMBtu/MWh</th></tr>
          </table>
        </div>
        <!-- Natural gas alpha -->
        <h5 class="input-header" data-bs-toggle="collapse" data-bs-target="#NG_alpha-div" aria-expanded="false" aria-controls="NG_alpha-div">
          Natural gas price at no electric sector use (2018$/MMBtu)
        </h5>
        <div id="NG_alpha-div" class="collapse">
          <table id="NG_alpha-table" class="table table-sm table-striped">
            <tr id="NG_alpha-header"></tr>
          </table>
        </div>
        <!-- Natural gas beta -->
        <h5 class="input-header" data-bs-toggle="collapse" data-bs-target="#NG_beta-div" aria-expanded="false" aria-controls="NG_beta-div">
          Natural gas price slope (2018$/MMBtu per Quad)
        </h5>
        <div id="NG_beta-div" class="collapse">
        </div>
        <!-- Value Factor -->
        <h5 class="input-header" data-bs-toggle="collapse" data-bs-target="#value_factor-div" aria-expanded="false" aria-controls="value_factor-div">
          Value factor (y) vs market share fraction (x)
        </h5>
        <div id="value_factor-div" class="collapse">
          <table id="value_factor-table" class="table table-sm table-striped">
            <tr id="value_factor-header"><th>Tech</th><th>y-intercept</th><th>slope</th></tr>
          </table>
        </div>
        <!-- CO2 Emissions -->
        <h5 class="input-header" data-bs-toggle="collapse" data-bs-target="#CO2_emission-div" aria-expanded="false" aria-controls="CO2_emission-div">
          CO2 Emissions (metric ton per MWh)
        </h5>
        <div id="CO2_emission-div" class="collapse">
          <table id="CO2_emission-table" class="table table-sm table-striped">
            <tr id="CO2_emission-header"><th>Tech</th><th>MT/MWh</th></tr>
          </table>
        </div>
        <!-- CO2 Price -->
        <h5 class="input-header" data-bs-toggle="collapse" data-bs-target="#CO2_price-div" aria-expanded="false" aria-controls="CO2_price-div">
          CO2 Price (2018$ per metric ton)
        </h5>
        <div id="CO2_price-div" class="collapse">
          <table id="CO2_price-table" class="table table-sm table-striped">
            <tr id="CO2_price-header"><th>Property</th><th>Value</th></tr>
          </table>
        </div>
        <!-- Reset button -->
        <a class="btn btn-primary" href="javascript:window.location=window.location.pathname;" role="button">Reset Inputs</a>
      </form>
      <div id="output-data">
        <h5 id="output-data-title">Output Data</h5>
        <h5 id="download-data">Download Results</h5>
      </div>
      <div id="run-analysis">
        <h5 id="run-analysis-title">Run Example analysis with TINIEST: Wind/PV LCOE Reduction</h5>
        <button id="run-analysis-button" class="btn btn-success">Run</button>
        <div id="run-analysis-loading">
          <span id="run-analysis-spinner" class="spinner-border text-success" role="status">
            <span class="visually-hidden">Loading...</span>
          </span>
          <span id="run-analysis-prefix"></span><span id="num_runs"></span><span id="run-analysis-suffix"></span>
        </div>
      </div>
      <p id="github-link">Github: <a href="https://github.com/mmowers/tiniest">https://github.com/mmowers/tiniest</a></p>
    </div>
    <div class="col">
      <div class="chart-container">
        <canvas id="generationChart"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="elecpriceChart"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="CO2Chart"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="costChart"></canvas>
      </div>
      <div id='CO2RangeChart'></div>
      <div id='VRERangeChart'></div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
<script>
"use strict";
var inputs = {
  num_time_steps: 4, //This means we have 4 input entries covering start year to end year, meaning 2020, 2030, 2040, 2050.
  num_tiny_steps: 100, //This will be the tiny time steps within the larger time steps
  start_year: 2020,
  end_year: 2050,
  CRF: .07,
  metric_comp: 'PLCOE', //'LCOE' is levelized cost of electricity, 'SLCOE' is system LCOE, 'PLCOE' is profitability-adjusted LCOE.
  cost_basis: 'LCOE', //Use either 'LCOE' to base costs on LCOE alone, 'metric_comp' to base costs on the metric of competition, or 'mixed' to use LCOE for existing and metric_comp for new techs.
  load: [3961, 4363, 4764, 5317], //TWh per year, 2020 adjusted to be equal to existing gen
  full_techs: ['Nuclear', 'Coal', 'Gas_CC', 'Gas_CCS', 'Wind_Ons', 'Wind_Ofs','PV', 'Other'],
  gas_techs: ['Gas_CC', 'Gas_CCS'],
  colors: {
    Nuclear: '#820000',
    Coal: '#222222',
    Gas_CC: '#52216B',
    Gas_CCS: '#C2A1DB',
    Wind_Ons: '#00B6EF',
    Wind_Ofs: '#106BA7',
    PV: '#FFC903',
    Other: '#ff69b4',
  },
  existing_gen: { //From ReEDS reference run, init, new1 and new2 techs. 2020 uses generation, and retirements of capacity scale this.
    Nuclear: [770, 719, 598, 377],
    Coal: [727, 551, 517, 312],
    Gas_CC: [1563, 1539, 1515, 1432],
    Gas_CCS: [0, 0, 0, 0],
    Wind_Ons: [370, 360, 240, 0],
    Wind_Ofs: [0, 0, 0, 0],
    PV: [154, 154, 153, 0], //Utility and Distributed gen in 2020, but only utility scales capacity
    Other: [377, 377, 377, 377], //Hydro and Other RE in 2020, constant over time
  },
  LCOE_new: { //2018$/MWh, ATB 2020 Moderate
    Nuclear: [75, 73, 70, 66],
    Coal: [72, 70, 69, 67], //High CF
    Gas_CC: [12, 11, 11, 11], //High CF, no fuel
    Gas_CCS: [29, 26, 25, 24], //High CF, no fuel
    Wind_Ons: [31, 24, 22, 19], //class 4
    Wind_Ofs: [81, 52, 44, 39], //class 4
    PV: [29, 17, 15, 13], //Kansas City, with 10% ITC. Without ITC would be [31, 18, 16, 14]
  },
  // LCOE_new: { //2019$/MWh, ATB 2021 Moderate (corrected version 2021-08-12)
  //   Nuclear: [80, 76, 73, 70],
  //   Coal: [67, 62, 59, 57], //High CF, plugging ATB 2021 heat rate, overnight capital cost, fixed and variable O&M into ATB 2020 spreadsheet now because the ATB 2021 spreadsheet doesn't have LCOE.
  //   Gas_CC: [13, 12, 12, 12], //High CF, no fuel, plugging ATB 2021 heat rate, overnight capital cost, fixed and variable O&M into ATB 2020 spreadsheet now because the ATB 2021 spreadsheet doesn't have LCOE.
  //   Gas_CCS: [32, 29, 26, 25], //High CF, no fuel, see note above
  //   Wind_Ons: [29, 21, 19, 17], //class 4
  //   Wind_Ofs: [75, 51, 43, 39], //class 3
  //   PV: [35, 19, 17, 15], //class 5, with 10% ITC.
  // },
  LCOE_exist: { //2018$/MWh, ATB 2020 Moderate, fixed and variable costs, kept constant though.
    Nuclear: [24, 24, 24, 24],
    Coal: [26, 26, 26, 26], //High CF
    Gas_CC: [4, 4, 4, 4], //High CF, no fuel
    Gas_CCS: [9, 9, 9, 9], //High CF, no fuel
    Wind_Ons: [9, 9, 9, 9], //class 4
    Wind_Ofs: [15, 15, 15, 15], //class 4
    PV: [7, 7, 7, 7], //Kansas City
  },
  // LCOE_exist: { //2018$/MWh, ATB 2020 Moderate, only variable costs, kept constant though.
  //   Nuclear: [10, 10, 10, 10],
  //   Coal: [21, 21, 21, 21], //High CF
  //   Gas_CC: [2, 2, 2, 2], //High CF, no fuel
  //   Gas_CCS: [6, 6, 6, 6], //High CF, no fuel
  //   Wind_Ons: [0, 0, 0, 0],
  //   Wind_Ofs: [0, 0, 0, 0],
  //   PV: [0, 0, 0, 0],
  // },
  LCOE_slope: { //2018$/MWh per petawatt-hour of generation, from reV outputs
    Nuclear: 0,
    Coal: 0,
    Gas_CC: 0,
    Gas_CCS: 0,
    Wind_Ons: 0.674,
    Wind_Ofs: 4.88,
    PV: 0.803,
  },
  NG_heatrate: { //Natural gas heat rate (MMBtu/MWh)
    Nuclear: 0,
    Coal: 0,
    Gas_CC: 6.4,
    Gas_CCS: 7.5,
    Wind_Ons: 0,
    Wind_Ofs: 0,
    PV: 0,
    Other: 0,
  },
  NG_alpha: [0.065, 1.26, 1.12, 1.20], //2018$/MMBtu, assuming no electric sector use, based on ReEDS alpha_AEO_2020_reference.csv (2004$) and ng_demand_AEO_2020_reference.csv
  // NG_alpha: [-.27, 1.21, 1.19, 1.01], //2019$/MMBtu, assuming no electric sector use, based on ReEDS alpha_AEO_2021_reference.csv (2004$) and ng_demand_AEO_2021_reference.csv
  NG_beta: 0.22, //$/MMBtu per Quad, based on ReEDS national beta of 0.1352 2004$/MMBtu (from b_inputs.gms) and regional beta in cd_beta0.csv
  value_factor: { //VF vs market share fraction, y-intercept and slope, based on reeds results.
    Nuclear: [.9, 0],
    Coal: [.9, 0], //copied from the others
    Gas_CC: [0.9, 0],
    Gas_CCS: [0.9, 0],
    Wind_Ons: [0.82, -1.08],
    Wind_Ofs: [0.85, -1.50],
    PV: [0.88, -1.30], //Advanced battery: [0.86, -0.96], Conservative battery: [0.91, -1.86]
  },
  CO2_emission: { //metric tons per MWh, ATB 2020 Moderate
    Nuclear: 0,
    Coal: 0.86,
    Gas_CC: 0.34,
    Gas_CCS: 0.04,
    Wind_Ons: 0,
    Wind_Ofs: 0,
    PV: 0,
    Other: 0,
  },
  CO2_price: { //2018 dollars per metric ton
    start_year: 2022,
    start_level: 0, //40 is our default carbon tax in ReEDS.
    escalation: 1.05,
  },
};

var urlData = Object.fromEntries([...new URLSearchParams(location.search)]);
for (var key in urlData){
  var arr = key.split('-');
  if(arr.length == 1 && arr[0] in inputs){
    if(isNumeric(urlData[key])){
      inputs[arr[0]] = Number(urlData[key]);
    }else{
      inputs[arr[0]] = urlData[key];
    }
  }
  else if(arr.length == 2 && arr[0] in inputs && arr[1] in inputs[arr[0]]){
    if(isNumeric(urlData[key])){
      inputs[arr[0]][arr[1]] = Number(urlData[key]);
    }else{
      inputs[arr[0]][arr[1]] = urlData[key];
    }
  }
  else if(arr.length == 3 && arr[0] in inputs && arr[1] in inputs[arr[0]] && arr[2] in inputs[arr[0]][arr[1]]){
    if(isNumeric(urlData[key])){
      inputs[arr[0]][arr[1]][arr[2]] = Number(urlData[key]);
    }else{
      inputs[arr[0]][arr[1]][arr[2]] = urlData[key];
    }
  }
}

var years = []
for (var i = 0; i < inputs.num_time_steps; i++) { //i is the index of the large time steps, and note that the final time step is the end
  years.push(inputs.start_year + i*(inputs.end_year - inputs.start_year)/(inputs.num_time_steps-1));
}

for (var year of years){
  $('#load-header').append('<th>' + year + '</th>');
  $('#existing_gen-header').append('<th>' + year + '</th>');
  $('#LCOE_new-header').append('<th>' + year + '</th>');
  $('#LCOE_exist-header').append('<th>' + year + '</th>');
  $('#NG_alpha-header').append('<th>' + year + '</th>');
}

//Load
var load_str = '<tr>';
for (var i = 0; i < inputs.num_time_steps; i++){
    load_str += '<td>' + inputs.load[i]+ '</td>';
    // load_str += '<td><input type="text" size="6" id="load-' + i + '" value="' + inputs.load[i]+ '"></td>';
}
load_str += '</tr>';
$('#load-table').append(load_str);
//Natural gas alpha
var NG_alpha_str = '<tr>';
for (var i = 0; i < inputs.num_time_steps; i++){
  NG_alpha_str += '<td><input type="text" size="6" id="NG_alpha-' + i + '" value="' + inputs.NG_alpha[i]+ '"></td>';
}
NG_alpha_str += '</tr>';
$('#NG_alpha-table').append(NG_alpha_str);
//Natural gas beta
$('#NG_beta-div').append('<input type="text" size="6" id="NG_beta" value="' + inputs.NG_beta + '">');

for (var tech of inputs.full_techs){
  var no_fuel_str = '';
  if(inputs.gas_techs.includes(tech)){
    no_fuel_str += ' (no fuel)';
  }
  if (!(tech in inputs.LCOE_new)){continue;}
  //Existing gen
  var existing_gen_str = '<tr><td>' + tech + '</td>';
  for (var i = 0; i < inputs.num_time_steps; i++){
    existing_gen_str += '<td><input type="text" size="6" id="existing_gen-' + tech + '-' + i + '" value="' + inputs.existing_gen[tech][i]+ '"></td>';
  }
  existing_gen_str += '</tr>';
  $('#existing_gen-table').append(existing_gen_str);
  //New tech LCOE
  var lcoe_new_str = '<tr><td>' + tech + no_fuel_str + '</td>';
  for (var i = 0; i < inputs.num_time_steps; i++){
    lcoe_new_str += '<td><input type="text" size="6" id="LCOE_new-' + tech + '-' + i + '" value="' + inputs.LCOE_new[tech][i]+ '"></td>';
  }
  lcoe_new_str += '</tr>';
  $('#LCOE_new-table').append(lcoe_new_str);
  //Existing tech LCOE
  var lcoe_exist_str = '<tr><td>' + tech + no_fuel_str + '</td>';
  for (var i = 0; i < inputs.num_time_steps; i++){
    lcoe_exist_str += '<td><input type="text" size="6" id="LCOE_exist-' + tech + '-' + i + '" value="' + inputs.LCOE_exist[tech][i]+ '"></td>';
  }
  lcoe_exist_str += '</tr>';
  $('#LCOE_exist-table').append(lcoe_exist_str);
  //LCOE Slope
  var lcoe_slope_str = '<tr><td>' + tech + '</td>';
  lcoe_slope_str += '<td><input type="text" size="6" id="LCOE_slope-' + tech + '" value="' + inputs.LCOE_slope[tech] + '"></td></tr>';
  $('#LCOE_slope-table').append(lcoe_slope_str);
  //Natural gas heat rate
  var NG_heatrate_str = '<tr><td>' + tech + '</td>';
  NG_heatrate_str += '<td><input type="text" size="6" id="NG_heatrate-' + tech + '" value="' + inputs.NG_heatrate[tech] + '"></td></tr>';
  $('#NG_heatrate-table').append(NG_heatrate_str);
  //Value Factor
  var vf_str = '<tr><td>' + tech + '</td>';
  for (var i = 0; i < 2; i++){
    vf_str += '<td><input type="text" size="6" id="value_factor-' + tech + '-' + i + '" value="' + inputs.value_factor[tech][i]+ '"></td>';
  }
  vf_str += '</tr>';
  $('#value_factor-table').append(vf_str);
  //Emissions
  var CO2_emission_str = '<tr><td>' + tech + '</td>';
  CO2_emission_str += '<td><input type="text" size="6" id="CO2_emission-' + tech + '" value="' + inputs.CO2_emission[tech] + '"></td></tr>';
  $('#CO2_emission-table').append(CO2_emission_str);
}

//CO2 price
var CO2_price_str = ''
for (var k in inputs.CO2_price){
  if (k == 'start_level'){
    CO2_price_str += '<tr><td>' + k + '</td><td><span id="CO2_price-slider-val">0</span><input type="range" min="0" max="99" size="6" id="CO2_price-' + k + '" value="' + inputs.CO2_price[k] + '"></td></tr>';
  }else{
    CO2_price_str += '<tr><td>' + k + '</td><td><input type="text" size="6" id="CO2_price-' + k + '" value="' + inputs.CO2_price[k] + '"></td></tr>';
  }
}
$('#CO2_price-table').append(CO2_price_str);

Chart.defaults.animation.duration = 500;

//Generation Chart. Start with existing gen here so that we can update as we go
var tech_gen_datasets = [];
for (var tech of inputs.full_techs){
  tech_gen_datasets.push({
    label: tech,
    data: [inputs.existing_gen[tech][0]],
    borderColor: inputs.colors[tech],
    backgroundColor: inputs.colors[tech],
  });
}

var gen_data_out = {
  labels: [inputs.start_year],
  datasets: tech_gen_datasets,
};
var gen_config_out = {
  type: 'bar',
  data: gen_data_out,
  options: {
    scales: {
      x: {
        type: 'linear',
        stacked: true,
        min: inputs.start_year,
        max: inputs.end_year,
        ticks: {
          callback: function(value, index, values) {
            return value.toString().replace(",", "");
          },
        },
      },
      y: {
        stacked: true,
        title: {
          display: true,
          text: 'Generation (TWh/yr)',
          font: {
            weight: 'bold',
          },
        },
      },
    },
    plugins: {
      legend: {
        position: 'right',
      },
    },
  },
};
var generationChart = new Chart(
  document.getElementById('generationChart'),
  gen_config_out,
);

//Cost Chart. Start with zero cost for the very first fraction of a year.
var tech_cost_datasets = [];
for (var tech of inputs.full_techs){
  tech_cost_datasets.push({
    label: tech,
    data: [0],
    borderColor: inputs.colors[tech],
    backgroundColor: inputs.colors[tech],
  });
}

var cost_data_out = {
  labels: [inputs.start_year],
  datasets: tech_cost_datasets,
};
var cost_config_out = {
  type: 'bar',
  data: cost_data_out,
  options: {
    scales: {
      x: {
        type: 'linear',
        stacked: true,
        min: inputs.start_year,
        max: inputs.end_year,
        ticks: {
          callback: function(value, index, values) {
            return value.toString().replace(",", "");
          },
        },
      },
      y: {
        stacked: true,
        title: {
          display: true,
          text: 'Cost (Bil$/yr)',
          font: {
            weight: 'bold',
          },
        },
      },
    },
    plugins: {
      legend: {
        position: 'right',
      },
    },
  },
};
var costChart = new Chart(
  document.getElementById('costChart'),
  cost_config_out,
);

//CO2 Emissions Chart. Start with existing emissions here so that we can update as we go
var CO2_tot_init = 0;
for (var tech of inputs.full_techs){
  CO2_tot_init += inputs.CO2_emission[tech] * inputs.existing_gen[tech][0];
}

var CO2_datasets = [{
    label: 'CO2',
    data: [CO2_tot_init],
    borderColor: 'rgb(255, 99, 132)',
    backgroundColor: 'rgb(255, 99, 132)',
}];

var CO2_data_out = {
  labels: [inputs.start_year],
  datasets: CO2_datasets,
};
var CO2_config_out = {
  type: 'line',
  data: CO2_data_out,
  options: {
    scales: {
      x: {
        type: 'linear',
        min: inputs.start_year,
        max: inputs.end_year,
        ticks: {
          callback: function(value, index, values) {
            return value.toString().replace(",", "");
          },
        },
      },
      y: {
        min: 0,
        title: {
          display: true,
          text: 'CO2 Emissions (MMton/yr)',
          font: {
            weight: 'bold',
          },
        },
      },
    },
    plugins: {
      legend: {
        position: 'right',
      },
    },
  },
};
var CO2Chart = new Chart(
  document.getElementById('CO2Chart'),
  CO2_config_out,
);

//Electricity Price Chart. Start with zero price, to be overridden later.
var elecprice_datasets = [{
    label: 'Electricity Price',
    data: [0],
    borderColor: 'rgb(54, 162, 235)',
    backgroundColor:  'rgb(54, 162, 235)',
}];

var elecprice_data_out = {
  labels: [inputs.start_year],
  datasets: elecprice_datasets,
};
var elecprice_config_out = {
  type: 'line',
  data: elecprice_data_out,
  options: {
    scales: {
      x: {
        type: 'linear',
        min: inputs.start_year,
        max: inputs.end_year,
        ticks: {
          callback: function(value, index, values) {
            return value.toString().replace(",", "");
          },
        },
      },
      y: {
        min: 0,
        title: {
          display: true,
          text: 'Bulk Electricity Price ($/MWh)',
          font: {
            weight: 'bold',
          },
        },
      },
    },
    plugins: {
      legend: {
        position: 'right',
      },
    },
  },
};
var elecpriceChart = new Chart(
  document.getElementById('elecpriceChart'),
  elecprice_config_out,
);

function runTiniest(inputs) {

  //First initialize outputs
  var year_labels = [inputs.start_year];
  var tech_gen_out = {};
  var tech_gen_exist_out = {}; //Generation from techs built before 2020
  var tech_gen_future_out = {}; //Generation from techs built after 2020
  var tech_cost_out = {};
  var tech_cost = {};
  var metrics_new_out = {};
  var metrics_exist_out = {};
  var LCOEs_new_out = {};
  var LCOEs_exist_out = {};
  for (var tech of inputs.full_techs){
    tech_gen_out[tech] = [inputs.existing_gen[tech][0]];
    tech_gen_exist_out[tech] = [inputs.existing_gen[tech][0]];
    tech_gen_future_out[tech] = [0];
    tech_cost_out[tech] = [0];
    tech_cost[tech] = 0;
    metrics_new_out[tech] = [0];
    metrics_exist_out[tech] = [0];
    LCOEs_new_out[tech] = [0];
    LCOEs_exist_out[tech] = [0];
  }
  var tot_load_out = [inputs.load[0]];
  var CO2_tot_out = [0];
  for (var tech of inputs.full_techs){
    CO2_tot_out[0] += inputs.CO2_emission[tech] * inputs.existing_gen[tech][0];
  }
  var elecprice_out = [0];
  var gas_price_out = [0];
  var gas_use_out = [0];

  //Now initialize some variables
  var years = []
  for (var i = 0; i < inputs.num_time_steps; i++) { //i is the index of the large time steps, and note that the final time step is the end
    years.push(inputs.start_year + i*(inputs.end_year - inputs.start_year)/(inputs.num_time_steps-1));
  }
  var tiny_step_yrs = (inputs.end_year - inputs.start_year)/(inputs.num_time_steps-1)/inputs.num_tiny_steps;
  var gen_future = {}; //Generation from techs built after 2020
  var gen_exist = {}; //Generation from techs built before 2020
  var gen_new = {}; //Generation from techs built in the current iteration.
  for(var tech of inputs.full_techs){
    gen_exist[tech] = inputs.existing_gen[tech][0];
    gen_future[tech] = 0;
    gen_new[tech] = 0;
  }
  var tot_gen_future = 0;
  var tot_load = inputs.load[0];

  for (var i = 0; i < inputs.num_time_steps - 1; i++) { //i is the index number of the large time steps, and note that the final time step is the end
    for (var j = 1; j <= inputs.num_tiny_steps; j++) { //j is the index number of the tiny time steps, starting at 1 because the starting point is prescribed
      var year = years[i] + j*(years[i+1] - years[i])/inputs.num_tiny_steps;
      //Reset new generation
      for(var tech in inputs.existing_gen){
        gen_new[tech] = 0;
      }
      //Calculate gas price
      var gas_use = 0; //Quads
      for(var tech of inputs.gas_techs){
        gas_use += (gen_future[tech] + gen_exist[tech])*inputs.NG_heatrate[tech]/1e3;
      }
      var NG_alpha = inputs.NG_alpha[i] + j*(inputs.NG_alpha[i+1] - inputs.NG_alpha[i])/inputs.num_tiny_steps;
      var gas_price = NG_alpha + inputs.NG_beta*gas_use;
      //Calculate carbon price
      var CO2_price = 0;
      if(year >= inputs.CO2_price.start_year){
        CO2_price = inputs.CO2_price.start_level*Math.pow(inputs.CO2_price.escalation, year - inputs.CO2_price.start_year);
      }
      //Use last year's chosen metric as the electricity price. If this is the first iteration, set to false
      if (i == 0 && j == 1){
        var elecprice = false;
      } else{
        var elecprice = chosen_new.metric
      }
      //Find new tech with lowest metric
      var chosen_new = getChosen('new', inputs, i, j, gen_future, gen_exist, tot_load, gas_price, CO2_price, [], elecprice);
      //grow load for this time step
      var tot_load = inputs.load[i] + j*(inputs.load[i+1] - inputs.load[i])/inputs.num_tiny_steps;
      //Get existing gen by tech and total existing gen
      var tot_gen_exist = 0;
      for(var tech in inputs.existing_gen){
        //Take minimum of generation as determined by forced retirements and current gen_exist, which could be lower because of endogenous retirements.
        gen_exist[tech] = Math.min(gen_exist[tech], inputs.existing_gen[tech][i] + j*(inputs.existing_gen[tech][i+1] - inputs.existing_gen[tech][i])/inputs.num_tiny_steps);
        tot_gen_exist += gen_exist[tech];
      }
      //Now fill the shortfall in generation with the tech with the lowest LCOE
      var shortfall = tot_load - tot_gen_exist - tot_gen_future;
      gen_new[chosen_new.tech] += shortfall;
      gen_future[chosen_new.tech] += shortfall;
      //Update tot_gen_future
      tot_gen_future = tot_load - tot_gen_exist;

      //If any existing tech has higher metric than the lowest metric of new techs, we will retire the existing gen,
      //then existing "new gen", in steps of shortfall, at each step adding the new tech with lowest metric and removing the
      //existing tech with highest metric.
      do {
        //Find the new tech with lowest metric
        chosen_new = getChosen('new', inputs, i, j, gen_future, gen_exist, tot_load, gas_price, CO2_price, [], elecprice);
        //Find the existing tech with the highest metric.
        var chosen_exist = getChosen('exist', inputs, i, j, gen_future, gen_exist, tot_load, gas_price, CO2_price, [chosen_new.tech], elecprice);
        //if existing metric is higher than lowest new metric, make the trade, based on shortfall:
        if(chosen_exist.metric > chosen_new.metric){
          if(gen_exist[chosen_exist.tech] > 0){
            //If we have less than shortfall of existing tech gen, use that remainder as the trade amount.
            var trade_energy = Math.min(gen_exist[chosen_exist.tech], shortfall);
            gen_exist[chosen_exist.tech] -= trade_energy;
            tot_gen_exist -= trade_energy;
            tot_gen_future += trade_energy;
          } else if(gen_future[chosen_exist.tech] > 0){
            var trade_energy = Math.min(gen_future[chosen_exist.tech], shortfall);
            gen_future[chosen_exist.tech] -= trade_energy;
          }
          gen_new[chosen_new.tech] += trade_energy;
          gen_future[chosen_new.tech] += trade_energy;
        }
        //Re-calculate gas price as gas_use may have changed
        gas_use = 0; //Quads
        for(var tech of inputs.gas_techs){
          gas_use += (gen_future[tech] + gen_exist[tech])*inputs.NG_heatrate[tech]/1e3;
        }
        gas_price = NG_alpha + inputs.NG_beta*gas_use;
      } while(chosen_exist.metric > chosen_new.metric);

      //Calculate total emissions
      var CO2_tot = 0;
      for (var tech of inputs.full_techs){
        CO2_tot += inputs.CO2_emission[tech] * (gen_future[tech] + gen_exist[tech]);
      }
      //Calculate tech-specific costs in Bil $
      for (var tech of inputs.full_techs){
        if (gen_future[tech] + gen_exist[tech] >= 0 && tech in chosen_new.LCOEs && tech in chosen_exist.LCOEs){
          if(inputs.cost_basis == "LCOE"){
            tech_cost[tech] += (
              gen_new[tech]*(chosen_new.LCOEs[tech] - chosen_exist.LCOEs[tech])/inputs.CRF +
              (gen_future[tech] + gen_exist[tech])*chosen_exist.LCOEs[tech]*tiny_step_yrs
            )/1e3;
          } else if (inputs.cost_basis == 'metric_comp'){
            tech_cost[tech] += (
              gen_new[tech]*(chosen_new.metrics[tech] - chosen_exist.metrics[tech])/inputs.CRF +
              (gen_future[tech] + gen_exist[tech])*chosen_exist.metrics[tech]*tiny_step_yrs
            )/1e3;
          } else if (inputs.cost_basis == 'mixed'){
            tech_cost[tech] += (
              gen_new[tech]*(chosen_new.metrics[tech] - chosen_exist.metrics[tech])/inputs.CRF +
              (gen_future[tech] + gen_exist[tech])*chosen_exist.LCOEs[tech]*tiny_step_yrs
            )/1e3;
          }
        }
      }

      //If this is the first iteration, reset the start year prices
      if (i == 0 && j == 1){
        elecprice_out[0] = chosen_new.metric;
        gas_price_out[0] = gas_price;
        gas_use_out[0] = gas_use;
        for (var tech of inputs.full_techs){
          metrics_new_out[tech][0] = chosen_new.metrics[tech];
          metrics_exist_out[tech][0] = chosen_exist.metrics[tech];
          LCOEs_new_out[tech][0] = chosen_new.LCOEs[tech];
          LCOEs_exist_out[tech][0] = chosen_exist.LCOEs[tech];
        }
      }
      //now update the chart data if we are on the year
      if (year % 1 == 0){
        year_labels.push(year);
        CO2_tot_out.push(CO2_tot);
        tot_load_out.push(tot_load);
        elecprice_out.push(chosen_new.metric);
        gas_price_out.push(gas_price);
        gas_use_out.push(gas_use);
        for (var tech of inputs.full_techs){
          tech_gen_out[tech].push(gen_future[tech] + gen_exist[tech]);
          tech_gen_exist_out[tech].push(gen_exist[tech]);
          tech_gen_future_out[tech].push(gen_future[tech]);
          tech_cost_out[tech].push(tech_cost[tech]);
          //Reset tech_cost after outputting.
          tech_cost[tech] = 0;
          metrics_new_out[tech].push(chosen_new.metrics[tech]);
          metrics_exist_out[tech].push(chosen_exist.metrics[tech]);
          LCOEs_new_out[tech].push(chosen_new.LCOEs[tech]);
          LCOEs_exist_out[tech].push(chosen_exist.LCOEs[tech]);
        }
      }
    }
  }
  return {year_labels: year_labels,
          tech_gen_out: tech_gen_out,
          tech_gen_exist_out: tech_gen_exist_out,
          tech_gen_future_out: tech_gen_future_out,
          tech_cost_out: tech_cost_out,
          metrics_new_out: metrics_new_out,
          metrics_exist_out: metrics_exist_out,
          LCOEs_new_out: LCOEs_new_out,
          LCOEs_exist_out: LCOEs_exist_out,
          elecprice_out: elecprice_out,
          gas_price_out: gas_price_out,
          gas_use_out: gas_use_out,
          CO2_tot_out: CO2_tot_out,
          tot_load_out: tot_load_out,
          };
}

function getChosen(new_or_exist, inputs, i, j, gen_future, gen_exist, tot_load, gas_price, CO2_price, exclude_techs, elecprice){
  //Get chosen tech and associated metric
  var first_tech = true;
  var metric_chosen, tech_chosen;
  var LCOEs = {};
  var metrics = {};
  for(var tech in inputs.LCOE_new){
    if(new_or_exist == 'exist' && gen_future[tech] + gen_exist[tech] <= 0) { continue;}
    //Use last step's market share for value factor calculation
    var tech_penetration = (gen_future[tech] + gen_exist[tech])/tot_load;
    //calculate value factor at this market share, y = mx + b
    var value_factor = inputs.value_factor[tech][1]*tech_penetration + inputs.value_factor[tech][0];
    //If value is zero or negative, don't consider this tech
    if(inputs.metric_comp == 'PLCOE' && value_factor <= 0) { continue;}
    //Get LCOE for this time step
    if(new_or_exist == 'new'){
      var LCOE = inputs.LCOE_new[tech][i] + j*(inputs.LCOE_new[tech][i+1] - inputs.LCOE_new[tech][i])/inputs.num_tiny_steps;
      //Add slope to LCOE
      LCOE += inputs.LCOE_slope[tech] * (gen_future[tech] + gen_exist[tech])/1000;
    }
    else if(new_or_exist == 'exist'){
      var LCOE = inputs.LCOE_exist[tech][i] + j*(inputs.LCOE_exist[tech][i+1] - inputs.LCOE_exist[tech][i])/inputs.num_tiny_steps;
    }
    //Add NG fuel cost to LCOE
    LCOE += gas_price * inputs.NG_heatrate[tech];
    //Add CO2 cost to LCOE
    LCOE += CO2_price * inputs.CO2_emission[tech];
    //Save LCOEs[tech] for output
    LCOEs[tech] = LCOE;
    //Calculate metric and keep track of the chosen metric and corresponding tech.
    if (inputs.metric_comp == 'PLCOE' || elecprice == false){
      var metric = LCOE/value_factor;
    } else if (inputs.metric_comp == 'SLCOE'){
      var metric = LCOE + elecprice - value_factor*elecprice;
    } else if (inputs.metric_comp == 'LCOE'){
      var metric = LCOE;
    }
    metrics[tech] = metric;
    if(exclude_techs.includes(tech)) { continue;}
    if (first_tech == true){
      metric_chosen = metric;
      tech_chosen = tech;
      first_tech = false;
    } else if (new_or_exist == 'new' && metric < metric_chosen){
      metric_chosen = metric;
      tech_chosen = tech;
    } else if (new_or_exist == 'exist' && metric > metric_chosen){
      metric_chosen = metric;
      tech_chosen = tech;
    }
  }
  return {metric: metric_chosen, tech: tech_chosen, LCOEs: LCOEs, metrics: metrics};
}

function updateCharts(outputs){
  generationChart.data.labels = outputs.year_labels;
  costChart.data.labels = outputs.year_labels;
  for(var n = 0; n < inputs.full_techs.length; n++){
    var tech = inputs.full_techs[n];
    generationChart.data.datasets[n].data = outputs.tech_gen_out[tech];
    costChart.data.datasets[n].data = outputs.tech_cost_out[tech];
  }
  generationChart.update() //it didn't seem to work to update within runTiniest(), perhaps because it was updating too fast.
  costChart.update()
  CO2Chart.data.labels = outputs.year_labels;
  CO2Chart.data.datasets[0].data = outputs.CO2_tot_out;
  CO2Chart.update()
  elecpriceChart.data.labels = outputs.year_labels;
  elecpriceChart.data.datasets[0].data = outputs.elecprice_out;
  elecpriceChart.update()
}

function isNumeric(str) {
  if (typeof str != "string") return false // we only process strings!
  return !isNaN(str) && // use type coercion to parse the _entirety_ of the string (`parseFloat` alone does not do this)...
         !isNaN(parseFloat(str)) // ...and ensure strings of whitespace fail
}

var outputs = runTiniest(inputs);
updateCharts(outputs);

$(document).on('input', 'input', function(){
  var arr = $(this).attr('id').split('-');
  if(arr.length == 1){
    if(isNumeric($(this).val())){
      inputs[arr[0]] = Number($(this).val());
    }else{
      inputs[arr[0]] = $(this).val();
    }
  }
  else if(arr.length == 2){
    if(isNumeric($(this).val())){
      inputs[arr[0]][arr[1]] = Number($(this).val());
    }else{
      inputs[arr[0]][arr[1]] = $(this).val();
    }
  }
  else if(arr.length == 3){
    if(isNumeric($(this).val())){
      inputs[arr[0]][arr[1]][arr[2]] = Number($(this).val());
    }else{
      inputs[arr[0]][arr[1]][arr[2]] = $(this).val();
    }
  }
  urlData[$(this).attr('id')] = $(this).val();
  if (history.pushState) {
    var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?' + $.param(urlData);
    window.history.pushState({path:newurl},'',newurl);
}
  outputs = runTiniest(inputs);
  updateCharts(outputs);
});

$(document).on('input', '#CO2_price-start_level', function(){
  $('#CO2_price-slider-val').text($(this).val());
});
$('#CO2_price-slider-val').text($('#CO2_price-start_level').val());

$('#download-data').click(function(){
  var rows = [['',''].concat(outputs.year_labels)]
  rows.push(['Load (TWh/yr)', ''].concat(outputs.tot_load_out))
  rows.push(['CO2 Emissions (MMton/yr)', ''].concat(outputs.CO2_tot_out))
  rows.push(['Elec Price (2018$/MWh)', ''].concat(outputs.elecprice_out))
  rows.push(['Gas Price (2018$/MMBtu)', ''].concat(outputs.gas_price_out))
  rows.push(['Gas Use (Quads)', ''].concat(outputs.gas_use_out))
  inputs.full_techs.forEach(function(tech, index, array){
    rows.push(['Gen (TWh/yr)', tech].concat(outputs.tech_gen_out[tech]))
  });
  inputs.full_techs.forEach(function(tech, index, array){
    rows.push(['Gen pre-2020 techs (TWh/yr)', tech].concat(outputs.tech_gen_exist_out[tech]))
  });
  inputs.full_techs.forEach(function(tech, index, array){
    rows.push(['Gen post-2020 techs (TWh/yr)', tech].concat(outputs.tech_gen_future_out[tech]))
  });
  inputs.full_techs.forEach(function(tech, index, array){
    rows.push(['Cost (Bil $/yr)', tech].concat(outputs.tech_cost_out[tech]))
  });
  inputs.full_techs.forEach(function(tech, index, array){
    rows.push([inputs.metric_comp + ' new', tech].concat(outputs.metrics_new_out[tech]))
  });
  inputs.full_techs.forEach(function(tech, index, array){
    rows.push([inputs.metric_comp + ' exist', tech].concat(outputs.metrics_exist_out[tech]))
  });
  inputs.full_techs.forEach(function(tech, index, array){
    rows.push(['LCOE new ($/MWh)', tech].concat(outputs.LCOEs_new_out[tech]))
  });
  inputs.full_techs.forEach(function(tech, index, array){
    rows.push(['LCOE exist ($/MWh)', tech].concat(outputs.LCOEs_exist_out[tech]))
  });

  var csvContent = "data:text/csv;charset=utf-8,"
    + rows.map(e => e.join(",")).join("\n");
  var encodedUri = encodeURI(csvContent);
  var link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "tiniest_results.csv");
  document.body.appendChild(link); // Required for FF
  link.click();
});


$('#run-analysis-button').click(function(){
  var start = Date.now();
  var mult_start = 1;
  var mult_end = 0;
  var mult_step = 0.02;
  var num_runs = Math.pow((mult_start - mult_end)/mult_step, 2);
  $('#run-analysis-prefix').text('Running TINIEST ');
  $('#num_runs').text(num_runs);
  $('#run-analysis-suffix').text(' times (~10 seconds).');
  $('#run-analysis-spinner').show();
  $('#run-analysis-loading').show();
  //setTimeout used here to make the function asynchronous, needed to display the loading icon properly.
  //See these for more info:
  //https://stackoverflow.com/questions/779379/why-is-settimeoutfn-0-sometimes-useful
  //https://stackoverflow.com/questions/749666/show-a-javascript-loader-image-while-function-is-executing
  setTimeout(function() {
  var result_range_out = {CO2_cum: [], CO2_end: [], VRE_end: [], PV_LCOE_end: [], Wind_LCOE_end: []};
  for(var pv_mult = mult_start; pv_mult >= mult_end; pv_mult -= mult_step){
    for(var wind_mult = mult_start; wind_mult >= mult_end; wind_mult -= mult_step){
      var inputs_cp = JSON.parse(JSON.stringify(inputs));
      for(var i = 0; i < inputs.num_time_steps; i++){
        //linearly change costs from no change to full mult change
        var pv_mult_interp = (pv_mult - 1)/(inputs.num_time_steps - 1)*i + 1;
        inputs_cp.LCOE_new.PV[i] *= pv_mult_interp;
        inputs_cp.LCOE_exist.PV[i] *= pv_mult_interp;
        var wind_mult_interp = (wind_mult - 1)/(inputs.num_time_steps - 1)*i + 1;
        inputs_cp.LCOE_new.Wind_Ons[i] *= wind_mult_interp;
        inputs_cp.LCOE_exist.Wind_Ons[i] *= wind_mult_interp;
      }
      var out = runTiniest(inputs_cp);
      var CO2_cum = 0;
      for(var i = 0; i < out.CO2_tot_out.length; i++){
        CO2_cum += out.CO2_tot_out[i];
      }
      var final_vre_share = (out.tech_gen_out.PV.slice(-1)[0] +
                             out.tech_gen_out.Wind_Ons.slice(-1)[0] +
                             out.tech_gen_out.Wind_Ofs.slice(-1)[0]
                            )/out.tot_load_out.slice(-1)[0];
      result_range_out.PV_LCOE_end.push(inputs_cp.LCOE_new.PV.slice(-1)[0]);
      result_range_out.Wind_LCOE_end.push(inputs_cp.LCOE_new.Wind_Ons.slice(-1)[0]);
      result_range_out.CO2_cum.push(CO2_cum);
      result_range_out.CO2_end.push(out.CO2_tot_out.slice(-1)[0]);
      result_range_out.VRE_end.push(final_vre_share);
    }
  }

  var trace1 = {
    x:result_range_out.PV_LCOE_end,
    y: result_range_out.Wind_LCOE_end,
    z: result_range_out.CO2_end,
    mode: 'markers',
    marker: {
      size: 4,
      line: {
      color: 'rgba(217, 217, 217, 0.14)',
      width: 0.5},
      opacity: 0.8},
    type: 'scatter3d'
  };

  var layout = {
    width: 700,
    height: 700,
    margin: {
      l: 0,
      r: 0,
      b: 100,
      t: 100
    },
    title: {
      text:'2050 CO2 emissions vs Wind_Ons/PV LCOE',
    },
    scene: {
      xaxis: {
        title: {
          text: 'PV 2050 LCOE',
          font: {
            family: 'Courier New, monospace',
            size: 18,
            color: '#7f7f7f'
          }
        },
      },
      yaxis: {
        title: {
          text: 'Wind_Ons 2050 LCOE',
          font: {
            family: 'Courier New, monospace',
            size: 18,
            color: '#7f7f7f'
          }
        }
      },
      zaxis: {
        title: {
          text: '2050 CO2 emissions (MMton)',
          font: {
            family: 'Courier New, monospace',
            size: 18,
            color: '#7f7f7f'
          }
        },
        range: [0, Math.max.apply(null, result_range_out.CO2_end)]
      },
    }
  };

  Plotly.newPlot('CO2RangeChart', [trace1], layout);

  var vre_share_trace = JSON.parse(JSON.stringify(trace1));
  vre_share_trace.z = result_range_out.VRE_end;
  var vre_share_layout = JSON.parse(JSON.stringify(layout));
  vre_share_layout.title.text = '2050 VRE share vs Wind_Ons/PV LCOE';
  vre_share_layout.scene.zaxis.title.text = '2050 VRE share';
  vre_share_layout.scene.zaxis.range = [0, 1];
  Plotly.newPlot('VRERangeChart', [vre_share_trace], vre_share_layout);

  $('#run-analysis-spinner').hide();
  $('#run-analysis-prefix').text('Done running TINIEST ');
  $('#run-analysis-suffix').text(' times in ' + String((Date.now() - start)/1000) + ' seconds. Scroll down to see results.');
  // $('#rangeChart')[0].scrollIntoView();
}, 0);
});

</script>
</body>
</html>